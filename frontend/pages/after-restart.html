<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Resource Hints for Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="https://api.superchessprep.com">
  <link rel="dns-prefetch" href="https://payments.superchessprep.com">
  <link rel="dns-prefetch" href="https://videos.superchessprep.com">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - SuperChessPrep</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    /* ... existing styles remain unchanged ... */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #111, #1c1c1c);
      color: #f5f5f5;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 140, 0, 0.3);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Logo */
    .logo-container {
      display: inline-flex;
      align-items: center;
      text-decoration: none;
      transition: all 0.3s;
    }

    .logo-container:hover {
      transform: scale(1.05);
    }

    .circle-logo {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid transparent;
      background: linear-gradient(white, white) padding-box,
                  linear-gradient(45deg, #ff8c00, #ffd700, #ff6347) border-box;
      animation: pulse 2s infinite;
      box-shadow: 0 0 20px rgba(255, 140, 0, 0.4);
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(255, 140, 0, 0.6), 0 0 20px rgba(255, 215, 0, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(255, 140, 0, 0), 0 0 25px rgba(255, 215, 0, 0.5);
      }
    }

    /* Navigation Right Side */
    .nav-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Back to Homepage Button */
    .dashboard-button {
      display: flex !important;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 140, 0, 0.3);
      border-radius: 25px;
      color: #ff8c00;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .dashboard-button:hover {
      background: rgba(255, 140, 0, 0.15);
      border-color: #ff8c00;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 140, 0, 0.3);
    }

    .dashboard-icon {
      font-size: 18px;
    }

    /* User Menu Button */
    .user-menu-button {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 140, 0, 0.3);
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .user-menu-button:hover {
      background: rgba(255, 140, 0, 0.15);
      border-color: #ff8c00;
      transform: translateY(-2px);
    }

    .user-avatar {
      width: 35px;
      height: 35px;
      background: linear-gradient(45deg, #ff8c00, #ff6347);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .user-name {
      color: #ffffff;
      font-weight: 600;
      font-size: 15px;
    }

    .menu-arrow {
      color: #ff8c00;
      font-size: 12px;
      transition: transform 0.3s;
    }

    .user-menu-button:hover .menu-arrow {
      transform: translateY(2px);
    }

    .dropdown-plan {
     font-size: 13px;
     color: #ff8c00;
     font-weight: 600;
     margin-top: 5px;
     padding: 5px 10px;
     background: rgba(255, 140, 0, 0.1);
     border-radius: 8px;
     text-align: center;
    }

    /* Dropdown Menu */
    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 10px;
      background: rgba(20, 20, 20, 0.98);
      border: 1px solid rgba(255, 140, 0, 0.4);
      border-radius: 15px;
      min-width: 250px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      overflow: hidden;
      z-index: 2000;
    }

    .dropdown-header {
      padding: 20px;
      background: linear-gradient(135deg, rgba(255, 140, 0, 0.1), rgba(255, 99, 71, 0.1));
      border-bottom: 1px solid rgba(255, 140, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .dropdown-avatar {
      width: 50px;
      height: 50px;
      background: linear-gradient(45deg, #ff8c00, #ff6347);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .dropdown-info {
      flex: 1;
    }

    .dropdown-name {
      color: #ffffff;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .dropdown-email {
      color: #aaa;
      font-size: 13px;
    }

    .dropdown-divider {
      height: 1px;
      background: rgba(255, 140, 0, 0.2);
      margin: 8px 0;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 20px;
      color: #ffffff;
      text-decoration: none;
      transition: all 0.3s;
      cursor: pointer;
    }

    .dropdown-item:hover {
      background: rgba(255, 140, 0, 0.15);
    }

    .dropdown-icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    .logout-item {
      color: #ff6b6b;
    }

    .logout-item:hover {
      background: rgba(255, 107, 107, 0.15);
    }

    /* Main Content */
    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 60px 20px;
    }

    .dashboard-header {
      text-align: center;
      margin-bottom: 60px;
    }

    .dashboard-title {
      font-family: 'Playfair Display', serif;
      font-size: 48px;
      color: #ff8c00;
      margin-bottom: 15px;
      text-shadow: 0 2px 8px rgba(255, 140, 0, 0.3);
    }

    .dashboard-subtitle {
      font-size: 18px;
      color: #ffbfaa;
    }

    /* Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 30px;
      margin-bottom: 60px;
    }

    .card {
      background: rgba(25, 25, 25, 0.7);
      border: 1px solid rgba(255, 140, 0, 0.3);
      border-radius: 20px;
      padding: 40px 30px;
      text-align: center;
      backdrop-filter: blur(12px);
      transition: all 0.4s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 140, 0, 0.05), rgba(255, 99, 71, 0.05));
      opacity: 0;
      transition: opacity 0.4s;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 35px rgba(255, 140, 0, 0.3);
      border-color: #ff8c00;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-icon {
      font-size: 48px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 22px;
      color: #ff8c00;
      font-weight: 700;
      margin-bottom: 12px;
      position: relative;
      z-index: 1;
    }

    .card-status {
      font-size: 16px;
      color: #ffbfaa;
      font-style: italic;
      position: relative;
      z-index: 1;
    }

    /* Popup Notification */
    .popup-notification {
      position: fixed;
      top: 30px;
      right: 30px;
      background: rgba(20, 20, 20, 0.98);
      border: 2px solid #ff8c00;
      border-radius: 15px;
      padding: 20px 30px;
      box-shadow: 0 10px 40px rgba(255, 140, 0, 0.4);
      display: none;
      z-index: 10000;
      backdrop-filter: blur(10px);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .popup-notification.show {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .popup-icon {
      font-size: 24px;
    }

    .popup-message {
      color: #ffffff;
      font-size: 16px;
      font-weight: 600;
    }

    /* Footer */
    .footer {
      border-top: 1px solid rgba(255, 140, 0, 0.3);
      background: #111;
      padding: 40px 20px;
      text-align: center;
      margin-top: 80px;
    }

    .footer-italic {
      font-style: italic;
      color: #ff8c00;
      font-size: 16px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .dashboard-title {
        font-size: 36px;
      }
      
      .cards-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .user-name {
        display: none;
      }

      .dashboard-button span:not(.dashboard-icon) {
        display: none;
      }

      .dashboard-icon {
        font-size: 20px;
      }
      
      .popup-notification {
        right: 20px;
        left: 20px;
        top: 20px;
      }
    }
  </style>
  <script src="/js/auth-client.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" integrity="sha512-H+rglffZ6f5gF7UJgvH4Naa+fGCgjrHKMgoFOGmcPTRwR6oILo5R+gtzNrpDp7iMV3udbymBVjkeZGNz1Em4rQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="/js/safe-html.js"></script>
  <script src="/js/logger.js"></script>
  <script src="/js/event-manager.js"></script>
  <script src="/js/performance-utils.js"></script>
  <link rel="stylesheet" href="/css/core_min.css">
</head>
<body>
  <!-- Logger fallback for inline scripts -->
  <script>
    if (typeof Logger === 'undefined') {
      window.Logger = {
        debug: function() {},
        info: function() {},
        warn: console.warn.bind(console, '[WARN]'),
        error: console.error.bind(console, '[ERROR]'),
        log: function() {}
      };
    }
  </script>

<!-- NEW: SOLUTION 1 - Auto Clear Preflight Cache -->
<script>
(function() {
  // Clear all caches
  if ('caches' in window) {
    caches.keys().then(keys => keys.forEach(key => caches.delete(key)));
  }
  
  // One-time reload to clear preflight cache
  const cacheKey = 'preflight_cleared_v1';
  if (!sessionStorage.getItem(cacheKey)) {
    sessionStorage.setItem(cacheKey, '1');
    console.log('üßπ Clearing preflight cache...');
    setTimeout(() => location.reload(true), 100);
  }
})();
</script>

  <!-- Header -->
  <header class="header">
    <nav class="nav-container">
      <!-- Logo -->
      <a href="/dashboard" class="logo-container">
        <img src="/images/circle-logo.webp" alt="SuperChessPrep" class="circle-logo">
      </a>
      
      <!-- Navigation Right Container -->
      <div class="nav-right">
        
        <!-- Back to Homepage Button -->
        <a href="/" class="dashboard-button">
          <span class="dashboard-icon">üè†</span>
          <span>Back to Homepage</span>
        </a>
        
        <!-- User Menu Button -->
        <div class="user-menu-button" onclick="toggleUserMenu()">
          <span class="user-avatar" id="userAvatar">üë§</span>
          <span class="user-name" id="userName">Loading...</span>
          <span class="menu-arrow">‚ñº</span>
          
          <!-- Dropdown Menu -->
          <div id="userDropdownMenu" class="user-dropdown" style="display: none;">
            <div class="dropdown-header">
              <div class="dropdown-avatar">üë§</div>
              <div class="dropdown-info">
                <div class="dropdown-name" id="usernameDisplay">Username</div>
                <div class="dropdown-email" id="emailDisplay">email@example.com</div>
                <div class="dropdown-plan" id="currentPlanDisplay">Current Plan: Free</div>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a href="#" onclick="showComingSoon('Profile'); return false;" class="dropdown-item">
              <span class="dropdown-icon">üë§</span>
              Profile
            </a>
            <a href="#" onclick="showComingSoon('Settings'); return false;" class="dropdown-item">
              <span class="dropdown-icon">‚öôÔ∏è</span>
              Settings
            </a>
            <div class="dropdown-divider"></div>
            <a href="#" onclick="handleLogout(); return false;" class="dropdown-item logout-item">
              <span class="dropdown-icon">üö™</span>
              Logout
            </a>
          </div>
        </div>
        
      </div>
    </nav>
  </header>

  <!-- Main Content -->
  <div class="main-content">
    <div class="dashboard-header">
      <h1 class="dashboard-title">Welcome to Your Dashboard</h1>
      <p class="dashboard-subtitle">Exciting features coming soon!</p>
    </div>

    <!-- 10 Cards Grid -->
    <div class="cards-grid">
      <!-- Subscription Card - PRVA kartica -->
      <div class="card" onclick="window.location.href='/subscription'" style="background: linear-gradient(135deg, rgba(255, 140, 0, 0.1), rgba(255, 99, 71, 0.1));">
        <div class="card-icon">üíé</div>
        <h3 class="card-title">Subscription Plans</h3>
        <p class="card-status">Upgrade your account</p>
        <div style="margin-top: 20px; font-size: 14px; color: #ffbfaa;">
          <strong>Current Plan:</strong> <span id="currentTierDisplay">Loading...</span>
        </div>
      </div>
      
      <!-- Card for Admin PGN Management (SAMO ADMIN) -->
      <div class="card" id="adminPgnCard" style="display: none;" onclick="location.href='/admin/pgn'">
        <div class="card-icon">‚öôÔ∏è</div>
        <h3 class="card-title">PGN Management</h3>
        <p class="card-description">Upload and manage chess exercises (Admin Only)</p>
      </div>
      
      <div class="card">
        <div class="card-icon">‚ôüÔ∏è</div>
        <h3 class="card-title">Endgames</h3>
        <p class="card-status">Coming Soon!</p>
      </div>

      <div class="card">
        <div class="card-icon">‚ôû</div>
        <h3 class="card-title">Middlegame</h3>
        <p class="card-status">Coming Soon!</p>
      </div>

      <div class="card">
        <div class="card-icon">üìñ</div>
        <h3 class="card-title">History</h3>
        <p class="card-status">Coming Soon!</p>
      </div>

      <div class="card">
        <div class="card-icon">üß†</div>
        <h3 class="card-title">Mentality & Correct Thinking</h3>
        <p class="card-status">Coming Soon!</p>
      </div>

      <div class="card">
        <div class="card-icon">üì∞</div>
        <h3 class="card-title">News & Novelties</h3>
        <p class="card-status">Coming Soon!</p>
      </div>

      <div class="card" onclick="location.href='/exercises'">
        <div class="card-icon">‚úèÔ∏è</div>
        <h3 class="card-title">Daily Exercises</h3>
        <p class="card-description">Practice with daily chess exercises</p>
      </div>

      <div class="card">
        <div class="card-icon">üìö</div>
        <h3 class="card-title">Choose Your Repertoire</h3>
        <p class="card-status">Coming Soon!</p>
      </div>

      <div class="card">
        <div class="card-icon">üé•</div>
        <h3 class="card-title">Live Shows</h3>
        <p class="card-status">Coming Soon!</p>
      </div>

      <div class="card">
        <div class="card-icon">üí¨</div>
        <h3 class="card-title">Community Discussions</h3>
        <p class="card-status">Coming Soon!</p>
      </div>

      <div class="card">
        <div class="card-icon">‚≠ê</div>
        <h3 class="card-title">Premium Features</h3>
        <p class="card-status">Coming Soon!</p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <p class="footer-italic">Powered by Pier Dreams</p>
  </footer>

  <!-- Popup Notification -->
  <div id="popupNotification" class="popup-notification">
    <span class="popup-icon" id="popupIcon">‚ÑπÔ∏è</span>
    <span class="popup-message" id="popupMessage"></span>
  </div>

  <script>
    // ============================================
    // PAYMENT API URL - PRODUCTION
    // ============================================
    // Auto-detect environment
    const PAYMENT_API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3004' 
      : 'https://payments.superchessprep.com';

    console.log('üåê PAYMENT_API_URL:', PAYMENT_API_URL);

    // ============================================
    // JWT TOKEN HELPER
    // ============================================

    /**
     * Get valid token or redirect to login if expired
     */
    async function getValidToken() {
      const token = localStorage.getItem('auth_token');
      
      if (!token) {
        Logger.warn('‚ö†Ô∏è No token found - redirecting to login');
        window.location.href = '/';
        return null;
      }
      
      // Decode token to check expiration (without verification)
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const expiresAt = payload.exp * 1000; // Convert to milliseconds
        const now = Date.now();
        
        // Check if token expires in less than 1 hour
        if (expiresAt - now < 3600000) {
          Logger.warn('‚ö†Ô∏è Token expires soon (less than 1 hour)');
        }
        
        // Check if already expired
        if (expiresAt < now) {
          Logger.error('‚ùå Token expired - redirecting to login');
          localStorage.removeItem('auth_token');
          localStorage.removeItem('session_token');
          showPopupNotification('Session expired. Please login again.', '‚è∞', 2000);
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
          return null;
        }
        
        return token;
      } catch (error) {
        Logger.error('‚ùå Invalid token format - redirecting to login');
        localStorage.removeItem('auth_token');
        window.location.href = '/';
        return null;
      }
    }

    // ============================================
    // ‚úÖ IMPROVED SUBSCRIPTION DATA LOADING WITH RETRY + CACHE BUSTING
    // ============================================
    
    async function loadSubscriptionData(maxRetries = 5, baseDelay = 1000) {
      let attempt = 0;
      
      const token = await getValidToken();
      if (!token) return null;
      
      while (attempt < maxRetries) {
        attempt++;
        
        try {
          const delay = Math.min(attempt * baseDelay, 5000);
          
          if (attempt > 1) {
            console.log(`‚è≥ Retry attempt ${attempt}/${maxRetries} (waiting ${delay}ms)...`);
            await new Promise(resolve => setTimeout(resolve, delay));
          }
          
          console.log('üîÑ Fetching subscription data...');
          
          // NEW: SOLUTION 2 - Cache Busting with Timestamp
          const cacheBuster = `?_t=${Date.now()}`;
          
          const response = await fetch(`${PAYMENT_API_URL}/api/subscription/status${cacheBuster}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            cache: 'no-store',  // CRITICAL - Prevents browser caching
            mode: 'cors'
          });

          if (response.status === 401 || response.status === 403) {
            Logger.error('‚ùå Unauthorized');
            localStorage.removeItem('auth_token');
            localStorage.removeItem('session_token');
            showPopupNotification('Session expired. Please login again.', 'üîí', 2000);
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
            return null;
          }
          
          if (response.status === 404 || response.status >= 500) {
            if (attempt < maxRetries) {
              Logger.warn(`‚ö†Ô∏è Got ${response.status}, will retry...`);
              continue;
            }
          }
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const data = await response.json();
          console.log('‚úÖ Subscription data loaded:', data);
          return data;

        } catch (error) {
          Logger.error(`‚ùå Attempt ${attempt} failed:`, error.message);
          
          if (attempt >= maxRetries) {
            Logger.error('‚ùå All retry attempts failed');
            showPopupNotification('Failed to load subscription. Please refresh.', '‚ö†Ô∏è', 3000);
            return null;
          }
        }
      }
      
      return null;
    }

    async function updateSubscriptionDisplay() {
      const data = await loadSubscriptionData();
      
      if (!data) {
        document.getElementById('currentTierDisplay').textContent = 'Free';
        document.getElementById('currentPlanDisplay').textContent = 'Current Plan: Free';
        return;
      }
      
      const tier = data.subscription.tier || 'free';
      const tierDisplay = tier.charAt(0).toUpperCase() + tier.slice(1);
      
      // Update card display
      document.getElementById('currentTierDisplay').textContent = tierDisplay;
      
      // Update dropdown display
      document.getElementById('currentPlanDisplay').textContent = `Current Plan: ${tierDisplay}`;
      
      // Set colors based on tier
      const colors = {
        free: '#aaa',
        basic: '#4CAF50',
        premium: '#ff8c00',
        elite: '#ffd700'
      };
      
      const color = colors[tier] || colors.free;
      document.getElementById('currentTierDisplay').style.color = color;
      document.getElementById('currentPlanDisplay').style.color = color;
    }

    // ============================================
    // UI HELPER FUNCTIONS
    // ============================================

    // Toggle user menu dropdown
    function toggleUserMenu() {
      const dropdown = document.getElementById('userDropdownMenu');
      const isVisible = dropdown.style.display === 'block';
      dropdown.style.display = isVisible ? 'none' : 'block';
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const userMenu = document.querySelector('.user-menu-button');
      const dropdown = document.getElementById('userDropdownMenu');
      
      if (!userMenu.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Show popup notification
    function showPopupNotification(message, icon = '‚ÑπÔ∏è', duration = 3000) {
      const popup = document.getElementById('popupNotification');
      const popupIcon = document.getElementById('popupIcon');
      const popupMessage = document.getElementById('popupMessage');
      
      popupIcon.textContent = icon;
      popupMessage.textContent = message;
      popup.classList.add('show');
      
      setTimeout(() => {
        popup.classList.remove('show');
      }, duration);
    }

    // Show "Coming Soon" message
    function showComingSoon(feature) {
      showPopupNotification(`${feature} feature is coming soon!`, 'üöß', 3000);
      document.getElementById('userDropdownMenu').style.display = 'none';
    }

    // Handle logout
    async function handleLogout() {
      try {
        // Close dropdown
        document.getElementById('userDropdownMenu').style.display = 'none';
        
        // Show loading notification
        showPopupNotification('Logging out...', '‚è≥', 1000);
        
        // Call logout API
        await AuthAPI.logout();
        
        // Show success message
        showPopupNotification('Logout successful!', '‚úÖ', 1500);
        
        // Redirect to homepage after short delay
        setTimeout(() => {
          window.location.href = '/';
        }, 1500);
      } catch (error) {
        Logger.error('Logout error:', error);
        showPopupNotification('Logout failed. Please try again.', '‚ùå', 3000);
      }
    }

    // Load user info
    async function loadUserInfo() {
      try {
        // Get user from localStorage (set by Auth system)
        const user = Auth.getCurrentUser();
        
        if (user && user.username && user.email) {
          // Update all user display elements
          const userNameEl = document.getElementById('userName');
          const usernameDisplayEl = document.getElementById('usernameDisplay');
          const emailDisplayEl = document.getElementById('emailDisplay');
          
          if (userNameEl) userNameEl.textContent = user.username;
          if (usernameDisplayEl) usernameDisplayEl.textContent = user.username;
          if (emailDisplayEl) emailDisplayEl.textContent = user.email;
          
          console.log('‚úÖ User info loaded:', user.username, user.email);
        } else {
          Logger.warn('‚ö†Ô∏è User data incomplete or missing');
          
          // Try to fetch from API
          try {
            const apiUser = await AuthAPI.checkAuth();
            if (apiUser && apiUser.user) {
              const userNameEl = document.getElementById('userName');
              const usernameDisplayEl = document.getElementById('usernameDisplay');
              const emailDisplayEl = document.getElementById('emailDisplay');
              
              if (userNameEl) userNameEl.textContent = apiUser.user.username;
              if (usernameDisplayEl) usernameDisplayEl.textContent = apiUser.user.username;
              if (emailDisplayEl) emailDisplayEl.textContent = apiUser.user.email;
              
              console.log('‚úÖ User info loaded from API:', apiUser.user.username, apiUser.user.email);
            }
          } catch (apiError) {
            Logger.error('Failed to fetch user from API:', apiError);
          }
        }
      } catch (error) {
        Logger.error('Error loading user info:', error);
      }
    }

    // ============================================
    // PAGE INITIALIZATION
    // ============================================

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ Dashboard initializing...');
      
      // Check if Auth object is available
      if (typeof Auth === 'undefined' || typeof AuthAPI === 'undefined') {
        Logger.error('‚ùå Auth system not loaded');
        showPopupNotification('Authentication error. Redirecting...', '‚ùå', 1000);
        setTimeout(() => {
          window.location.href = '/';
        }, 1000);
        return;
      }

      // Check if user is authenticated
      if (!Auth.isLoggedIn()) {
        Logger.warn('‚ö†Ô∏è User not logged in');
        showPopupNotification('Please login to access dashboard', 'üîí', 1000);
        setTimeout(() => {
          window.location.href = '/';
        }, 1000);
        return;
      }

      // Load user information
      await loadUserInfo();
      
      // Load subscription data with retry logic
      await updateSubscriptionDisplay();
      
      console.log('‚úÖ Dashboard loaded successfully');
      
      // Show admin PGN card only for admins
      const user = Auth.getCurrentUser();
      if (user && user.role === 'admin') {
        document.getElementById('adminPgnCard').style.display = 'block';
      }
    });
  </script>
</body>
</html>