/**
 * Global Error Boundary
 * Generated by mega_patch.py
 * 
 * Catches and handles uncaught errors gracefully
 */
(function() {
    'use strict';
    
    const ErrorBoundary = {
        errors: [],
        maxErrors: 10,
        
        init: function() {
            // Catch uncaught errors
            window.onerror = (message, source, lineno, colno, error) => {
                this.handleError({
                    type: 'uncaught',
                    message,
                    source,
                    lineno,
                    colno,
                    stack: error?.stack
                });
                return false; // Don't suppress
            };
            
            // Catch unhandled promise rejections
            window.addEventListener('unhandledrejection', (event) => {
                this.handleError({
                    type: 'unhandledrejection',
                    message: event.reason?.message || String(event.reason),
                    stack: event.reason?.stack
                });
            });
            
            Logger.debug('[ErrorBoundary] Initialized');
        },
        
        handleError: function(errorInfo) {
            // Log error
            Logger.error('[ErrorBoundary] Caught error:', errorInfo);
            
            // Store error
            this.errors.push({
                ...errorInfo,
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent
            });
            
            // Keep only recent errors
            if (this.errors.length > this.maxErrors) {
                this.errors.shift();
            }
            
            // Show user-friendly message for critical errors
            if (this.isCriticalError(errorInfo)) {
                this.showErrorUI(errorInfo);
            }
        },
        
        isCriticalError: function(errorInfo) {
            // Define what constitutes a critical error
            const criticalPatterns = [
                /ChunkLoadError/i,
                /Loading chunk/i,
                /Network Error/i,
                /Failed to fetch/i
            ];
            
            return criticalPatterns.some(pattern => 
                pattern.test(errorInfo.message) || pattern.test(errorInfo.stack || '')
            );
        },
        
        showErrorUI: function(errorInfo) {
            // Create error toast if not already shown
            if (document.getElementById('error-boundary-toast')) return;
            
            const toast = document.createElement('div');
            toast.id = 'error-boundary-toast';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #ff4444;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 999999;
                max-width: 400px;
                font-family: system-ui, sans-serif;
            `;
            toast.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 8px;">⚠️ Something went wrong</div>
                <div style="font-size: 14px; opacity: 0.9;">Please refresh the page or try again later.</div>
                <button onclick="location.reload()" style="
                    margin-top: 12px;
                    background: white;
                    color: #ff4444;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                ">Refresh Page</button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                toast.remove();
            }, 10000);
        },
        
        getErrors: function() {
            return [...this.errors];
        },
        
        clearErrors: function() {
            this.errors = [];
        }
    };
    
    // Auto-init
    ErrorBoundary.init();
    
    // Expose globally
    window.ErrorBoundary = ErrorBoundary;
})();
