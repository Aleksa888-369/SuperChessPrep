!function(e){"use strict";var t=e.location.hostname,n="localhost"===t||"127.0.0.1"===t,o="superchessprep.com"===t||"www.superchessprep.com"===t,s=-1!==t.indexOf("152.53.186.105"),r=n?"development":o?"production":"staging",a="152.53.186.105",c={MAIN:n?"http://localhost:3000":o?"https://www.superchessprep.com":s?"http://"+a+":3000":"http://localhost:3000",AUTH:n?"http://localhost:3003":o?"https://api.superchessprep.com":s?"http://"+a+":3003":"http://localhost:3003",PAYMENT:n?"http://localhost:3004":o?"https://payments.superchessprep.com":s?"http://"+a+":3004":"http://localhost:3004",PGN:n?"http://localhost:3005":o?"https://pgn.superchessprep.com":s?"http://"+a+":3005":"http://localhost:3005",VIDEO:n?"http://localhost:3007":o?"https://videos.superchessprep.com":s?"http://"+a+":3007":"http://localhost:3007",FORUM:n?"http://localhost:3000":o?"https://www.superchessprep.com":s?"http://"+a+":3000":"http://localhost:3000",NEWS:n?"http://localhost:3000":o?"https://www.superchessprep.com":s?"http://"+a+":3000":"http://localhost:3000",UPLOAD:n?"http://localhost:3007":o?"https://videos.superchessprep.com":s?"http://"+a+":3007":"http://localhost:3007",BACKEND:n?"http://localhost:3003/api":o?"https://api.superchessprep.com/api":s?"http://"+a+":3003/api":"http://localhost:3003/api"},l={TIERS:{free:"‚ôü",basic:"‚ôô",premium:"‚ôò",elite:"‚ôî",admin:"üëë"},CHESS_WHITE:{king:"‚ôî",queen:"‚ôï",rook:"‚ôñ",bishop:"‚ôó",knight:"‚ôò",pawn:"‚ôô"},CHESS_BLACK:{king:"‚ôö",queen:"‚ôõ",rook:"‚ôú",bishop:"‚ôù",knight:"‚ôû",pawn:"‚ôü"},NAV:{home:"üè†",dashboard:"üìä",courses:"üìö",exercises:"‚ôüÔ∏è",videos:"üé¨",forum:"üí¨",news:"üì∞",shop:"üõí",settings:"‚öôÔ∏è",logout:"üö™",admin:"üîê",profile:"üë§",back:"‚Üê",menu:"‚ò∞"},STATUS:{success:"‚úÖ",error:"‚ùå",warning:"‚ö†Ô∏è",info:"‚ÑπÔ∏è",loading:"‚è≥",locked:"üîí",unlocked:"üîì",star:"‚≠ê",fire:"üî•",check:"‚úì",cross:"‚úï",edit:"‚úèÔ∏è",delete:"üóëÔ∏è",save:"üíæ",cancel:"‚úñÔ∏è"},TOPIC:{open:"üîì",closed:"üîí",pinned:"üìå",announcement:"üì¢",hot:"üî•",solved:"‚úÖ"},ARROWS:{left:"‚Üê",right:"‚Üí",up:"‚Üë",down:"‚Üì",expand:"‚ñº",collapse:"‚ñ≤"}},d={NOTIFICATION:3e3,NOTIFICATION_ERROR:5e3,NOTIFICATION_SUCCESS:3e3,AUTO_REFRESH:3e4,DEBOUNCE:300,DEBOUNCE_SEARCH:500,API_TIMEOUT:3e4,HEALTH_CHECK:6e4,REDIRECT_DELAY:1500,TOAST_DURATION:4e3,MODAL_ANIMATION:300,SW_UPDATE_CHECK:3e5},u={LEVELS:{free:0,basic:1,premium:2,elite:3,admin:999},LIMITS:{free:0,basic:5,premium:15,elite:30,admin:999},NAMES:{free:"Free",basic:"Basic",premium:"Premium",elite:"Elite",admin:"Administrator"},COLORS:{free:"#888888",basic:"#4CAF50",premium:"#ff8c00",elite:"#ffd700",admin:"#ef4444"},BG_COLORS:{free:"#f5f5f5",basic:"#e8f5e9",premium:"#fff3e0",elite:"#fffde7",admin:"#ffebee"},hasAccess:function(e,t){return(this.LEVELS[e]||0)>=(this.LEVELS[t]||0)},getLimit:function(e){return this.LIMITS[e]||0},getName:function(e){return this.NAMES[e]||"Unknown"},getIcon:function(e){return l.TIERS[e]||l.TIERS.free},getColor:function(e){return this.COLORS[e]||this.COLORS.free},getBgColor:function(e){return this.BG_COLORS[e]||this.BG_COLORS.free},isAdmin:function(e){return(this.LEVELS[e]||0)>=999},isPaid:function(e){var t=this.LEVELS[e]||0;return t>0&&t<999},isFree:function(e){return 0===(this.LEVELS[e]||0)},getBadge:function(e){var t=this.getIcon(e),n=this.getName(e);return'<span class="tier-badge" style="color:'+this.getColor(e)+'">'+t+" "+n+"</span>"}};function m(e){var t=(e||"main").toUpperCase();return c[t]||c.MAIN}e.CONFIG={VERSION:"3.0.0",ENV:r,isLocalhost:n,isProduction:o,isServerIP:s,hostname:t,SERVER_IP:a,DOMAIN:"superchessprep.com",API:c,ICONS:l,TIMING:d,CACHE:{NONE:0,SHORT:60,MEDIUM:300,LONG:3600,DAY:86400,WEEK:604800,MONTH:2592e3,YEAR:31536e3},TIERS:u,FILE_LIMITS:{VIDEO_MAX:5368709120,VIDEO_MAX_MB:5120,IMAGE_MAX:10485760,IMAGE_MAX_MB:10,PGN_MAX:5242880,PGN_MAX_MB:5,AVATAR_MAX:2097152,AVATAR_MAX_MB:2},FILE_TYPES:{VIDEO:["video/mp4","video/webm","video/ogg"],IMAGE:["image/jpeg","image/png","image/gif","image/webp"],PGN:[".pgn","application/x-chess-pgn","text/plain"],DOCUMENT:["application/pdf","application/msword"]},PATTERNS:{EMAIL:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,USERNAME:/^[a-zA-Z0-9_]{3,20}$/,PASSWORD_MIN_LENGTH:8,PHONE:/^\+?[\d\s-]{10,}$/},formatFileSize:function(e){return 0===e?"0 Bytes":(Math.floor(Math.log(e)/Math.log(1024)),parseFloat((e/Math.pow(1024,i)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][i])},getCorrelationId:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},getApiUrl:m,buildApiUrl:function(e,t){return m(e)+(t.startsWith("/")?t:"/"+t)},debounce:function(e,t){var n;return function(){var o=this,s=arguments;clearTimeout(n),n=setTimeout(function(){e.apply(o,s)},t||d.DEBOUNCE)}},formatDate:function(e,t){var n=new Date(e);if(isNaN(n.getTime()))return"Invalid Date";if("short"===(t=t||"short"))return n.toLocaleDateString();if("long"===t)return n.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"});if("time"===t)return n.toLocaleTimeString();if("full"===t)return n.toLocaleString();if("relative"===t){var o=new Date-n,s=Math.floor(o/1e3),r=Math.floor(s/60),i=Math.floor(r/60),a=Math.floor(i/24);return a>7?n.toLocaleDateString():a>0?a+" day"+(a>1?"s":"")+" ago":i>0?i+" hour"+(i>1?"s":"")+" ago":r>0?r+" minute"+(r>1?"s":"")+" ago":"Just now"}return n.toLocaleString()},escapeHtml:function(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML},truncate:function(e,t){return t=t||100,e.length<=t?e:e.substring(0,t)+"..."}}}(window);const StateManager=function(){"use strict";const e={user:null,token:null,isAuthenticated:!1,subscription:{tier:"free",status:"inactive",expiresAt:null},loading:{},errors:{},modals:{},cache:{exercises:null,videos:null,topics:null,lastFetch:{}}},t={},n="auth_token",o="user_data";function s(n,o){t[n]&&t[n].forEach(t=>{try{t(o,e)}catch(e){Logger.error(`[StateManager] Subscriber error for ${n}:`,e)}}),t["*"]&&t["*"].forEach(t=>{try{t(n,o,e)}catch(e){Logger.error("[StateManager] Wildcard subscriber error:",e)}})}function r(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date(e);if(Array.isArray(e))return e.map(r);const t={};for(const n in e)e.hasOwnProperty(n)&&(t[n]=r(e[n]));return t}function a(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch(e){Logger.error("[StateManager] Storage error:",e)}}function c(e){try{const t=localStorage.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch(e){return t}}catch(e){return Logger.error("[StateManager] Storage read error:",e),null}}return{getState(t){if(!t)return r(e);const n=t.split(".");let o=e;for(const e of n){if(null==o)return;o=o[e]}return r(o)},setState(t,n,o={}){const{persist:r=!1,silent:c=!1}=o,l=t.split("."),d=l.pop();let u=e;for(const e of l)void 0===u[e]&&(u[e]={}),u=u[e];const m=u[d];if(u[d]=n,r&&a(`scp_${t}`,n),!c&&m!==n){s(t,n);for(let e=l.length-1;e>=0;i--){const t=l.slice(0,e+1).join(".");s(t,this.getState(t))}}return n},subscribe(e,n){if("function"!=typeof n)throw new Error("Callback must be a function");return t[e]||(t[e]=[]),t[e].push(n),()=>{const o=t[e].indexOf(n);o>-1&&t[e].splice(o,1)}},init(){const t=c(n);t&&(this.setState("token",t),this.setState("isAuthenticated",!0));const s=c(o);return s&&(this.setState("user",s),this.setState("subscription.tier",s.subscription_tier||"free")),Logger.debug("[StateManager] Initialized",{isAuthenticated:e.isAuthenticated,tier:e.subscription.tier}),this},login(e,t){a(n,e),a(o,t),this.setState("token",e),this.setState("user",t),this.setState("isAuthenticated",!0),this.setState("subscription.tier",t.subscription_tier||"free"),s("auth",{token:e,user:t,isAuthenticated:!0})},logout(){localStorage.removeItem(n),localStorage.removeItem(o),this.setState("token",null),this.setState("user",null),this.setState("isAuthenticated",!1),this.setState("subscription",{tier:"free",status:"inactive"}),this.setState("cache",{exercises:null,videos:null,topics:null,lastFetch:{}}),s("auth",{token:null,user:null,isAuthenticated:!1})},setLoading(e,t){this.setState(`loading.${e}`,t)},isLoading:t=>!0===e.loading[t],setError(e,t){this.setState(`errors.${e}`,t)},clearError(e){this.setState(`errors.${e}`,null)},getError:t=>e.errors[t],openModal(e,t={}){this.setState(`modals.${e}`,{isOpen:!0,data:t})},closeModal(e){this.setState(`modals.${e}`,{isOpen:!1,data:null})},isModalOpen:t=>!0===e.modals[t]?.isOpen,setCache(e,t,n=300){this.setState(`cache.${e}`,t),this.setState(`cache.lastFetch.${e}`,Date.now()+1e3*n)},getCache(t){const n=e.cache.lastFetch[t];return n&&Date.now()>n?(this.setState(`cache.${t}`,null),null):e.cache[t]},isCacheValid(t){const n=e.cache.lastFetch[t];return n&&Date.now()<n},debug(){"development"===process.env.NODE_ENV||window.DEBUG}}}();"undefined"!=typeof window&&document.addEventListener("DOMContentLoaded",()=>{StateManager.init()}),"undefined"!=typeof module&&module.exports&&(module.exports=StateManager);const ApiClient=function(){"use strict";const e=window.API_BASE_URL||"",t=3e4,n=3,o=1e3,s=2,r=50;let i=navigator.onLine,a=[],c=null;async function l(){i=!0,window.dispatchEvent(new CustomEvent("api:online")),await async function(){if(0===a.length)return;const e=[...a];a=[];for(const t of e)try{const e=await g(t.options);t.resolve&&t.resolve(e)}catch(e){Logger.error("[ApiClient] Queued request failed:",e),t.reject&&t.reject(e)}window.dispatchEvent(new CustomEvent("api:queue-processed",{detail:{count:e.length}}))}()}function d(){i=!1,window.dispatchEvent(new CustomEvent("api:offline"))}function u(e,t){return!t||(t>=500||(429===t||"AbortError"===e.name))}async function m(e,t,r=0){try{const n=await p(e,t);if(!n.ok&&u(null,n.status))throw{status:n.status,retryable:!0};return n}catch(a){if(r<n&&(a.retryable||u(a))){const n=o*Math.pow(s,r);return await(i=n,new Promise(e=>setTimeout(e,i))),m(e,t,r+1)}throw a}var i}async function p(e,n={}){const o=new AbortController,s=n.timeout||t,r=setTimeout(()=>{o.abort()},s);try{const t=await fetch(e,{...n,signal:o.signal});return clearTimeout(r),t}catch(e){throw clearTimeout(r),e}}async function g(t){const{method:n="GET",endpoint:o,data:s,headers:l={},requiresAuth:d=!0,queueIfOffline:u=!1,skipRetry:g=!1}=t;if(!i){if(u&&"GET"!==n)return function(e){return new Promise((t,n)=>{a.length>=r?n(new Error("Offline queue is full")):(a.push({options:e,resolve:t,reject:n,timestamp:Date.now()}),window.dispatchEvent(new CustomEvent("api:request-queued",{detail:{queueLength:a.length}})))})}(t);throw new h("You are offline. Please check your connection.",0,"OFFLINE")}const f=`${e}${o}`,y={"Content-Type":"application/json",...l};d&&c&&(y.Authorization=`Bearer ${c}`);const v={method:n,headers:y};s&&"GET"!==n&&(v.body=JSON.stringify(s));try{const e=g?await p(f,v):await m(f,v),t=e.headers.get("content-type");let n;if(n=t&&t.includes("application/json")?await e.json():await e.text(),!e.ok)throw new h(n.error||n.message||"Request failed",e.status,n.code||"API_ERROR");return n}catch(e){if(e instanceof h)throw e;if("AbortError"===e.name)throw new h("Request timed out. Please try again.",0,"TIMEOUT");if("Failed to fetch"===e.message)throw new h("Unable to connect to server. Please check your connection.",0,"NETWORK_ERROR");throw new h(e.message||"Unknown error occurred",0,"UNKNOWN")}}class h extends Error{constructor(e,t,n){super(e),this.name="ApiError",this.status=t,this.code=n}}return{init(){window.addEventListener("online",l),window.addEventListener("offline",d),i=navigator.onLine;const e=localStorage.getItem("auth_token");return e&&(c=e),this},setToken(e){c=e,e?localStorage.setItem("auth_token",e):localStorage.removeItem("auth_token")},clearAuth(){c=null,localStorage.removeItem("auth_token")},isOnline:()=>i,getQueueLength:()=>a.length,get:async(e,t={})=>g({method:"GET",endpoint:e,...t}),post:async(e,t,n={})=>g({method:"POST",endpoint:e,data:t,...n}),put:async(e,t,n={})=>g({method:"PUT",endpoint:e,data:t,...n}),delete:async(e,t={})=>g({method:"DELETE",endpoint:e,...t}),patch:async(e,t,n={})=>g({method:"PATCH",endpoint:e,data:t,...n}),auth:{async login(e,t){const n=await g({method:"POST",endpoint:"/api/auth/login",data:{email:e,password:t},requiresAuth:!1});return n.token&&ApiClient.setToken(n.token),n},register:async(e,t,n)=>g({method:"POST",endpoint:"/api/auth/register",data:{username:e,email:t,password:n},requiresAuth:!1}),async logout(){try{await g({method:"POST",endpoint:"/api/auth/logout"})}finally{ApiClient.clearAuth()}}},users:{getProfile:async()=>g({endpoint:"/api/users/profile"}),updateProfile:async e=>g({method:"PUT",endpoint:"/api/users/profile",data:e})},exercises:{async getAll(e={}){const t=new URLSearchParams(e).toString();return g({endpoint:"/api/exercises"+(t?"?"+t:"")})},getById:async e=>g({endpoint:`/api/exercises/${e}`})},videos:{getAll:async()=>g({endpoint:"/api/videos"}),getById:async e=>g({endpoint:`/api/videos/${e}`})},forum:{getTopics:async()=>g({endpoint:"/api/forum/topics"}),getPinnedTopics:async()=>g({endpoint:"/api/forum/topics/pinned"}),createPost:async(e,t)=>g({method:"POST",endpoint:`/api/forum/topics/${e}/posts`,data:{content:t},queueIfOffline:!0})},subscriptions:{getStatus:async()=>g({endpoint:"/api/subscriptions/status"}),checkout:async e=>g({method:"POST",endpoint:"/api/subscriptions/checkout",data:{priceId:e}})},ApiError:h}}();"undefined"!=typeof document&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>ApiClient.init()):ApiClient.init()),"undefined"!=typeof module&&module.exports&&(module.exports=ApiClient);const getAuthApiUrl=()=>{const e=window.location.hostname;return"superchessprep.com"===e||"www.superchessprep.com"===e?"https://api.superchessprep.com/api":"localhost"===e||"127.0.0.1"===e?"http://localhost:3003/api":e.includes("152.53.186.105")?`http://${e}:3003/api`:`https://api.${e}/api`},AUTH_API_URL=getAuthApiUrl();function decodeJWT(e){try{if(!e)return null;const t=e.split(".");if(3!==t.length)return null;return JSON.parse(atob(t[1]))}catch(e){return Logger.error("[ERROR] JWT decode error:",e),null}}function isTokenExpired(e,t=60){const n=decodeJWT(e);if(!n||!n.exp)return!0;const o=Math.floor(Date.now()/1e3);return n.exp<o+t}function getTokenTimeRemaining(e){const t=decodeJWT(e);if(!t||!t.exp)return 0;const n=Math.floor(Date.now()/1e3);return Math.max(0,t.exp-n)}const storage={setToken:e=>localStorage.setItem("auth_token",e),getToken:()=>localStorage.getItem("auth_token"),removeToken:()=>localStorage.removeItem("auth_token"),setUser:e=>localStorage.setItem("user",JSON.stringify(e)),getUser:()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null},removeUser:()=>localStorage.removeItem("user"),setSessionToken:e=>localStorage.setItem("session_token",e),getSessionToken:()=>localStorage.getItem("session_token"),removeSessionToken:()=>localStorage.removeItem("session_token"),setTempToken:e=>sessionStorage.setItem("temp_token",e),getTempToken:()=>sessionStorage.getItem("temp_token"),removeTempToken:()=>sessionStorage.removeItem("temp_token"),setTempEmail:e=>sessionStorage.setItem("temp_email",e),getTempEmail:()=>sessionStorage.getItem("temp_email"),removeTempEmail:()=>sessionStorage.removeItem("temp_email"),clearAll:()=>{localStorage.removeItem("auth_token"),localStorage.removeItem("user"),localStorage.removeItem("session_token"),sessionStorage.removeItem("temp_token"),sessionStorage.removeItem("temp_email")}};let isRefreshing=!1,refreshPromise=null;async function refreshTokenWithSession(){const e=storage.getSessionToken();return e?(isRefreshing||(isRefreshing=!0,refreshPromise=(async()=>{try{const t=await fetch(`${AUTH_API_URL}/auth/refresh-session`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionToken:e})}),n=await t.json();return t.ok&&n.success&&n.token?(storage.setToken(n.token),n.user&&storage.setUser(n.user),n.token):("SESSION_EXPIRED"!==n.code&&"SESSION_NOT_FOUND"!==n.code||storage.clearAll(),null)}catch(e){return Logger.error("[ERROR] Token refresh error:",e),null}finally{isRefreshing=!1,refreshPromise=null}})()),refreshPromise):null}async function refreshTokenWithJWT(){const e=storage.getToken();if(!e)return null;try{const t=await fetch(`${AUTH_API_URL}/auth/refresh-token`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}),n=await t.json();return t.ok&&n.success&&n.token?(storage.setToken(n.token),n.user&&storage.setUser(n.user),n.token):null}catch(e){return Logger.error("[ERROR] JWT refresh error:",e),null}}async function apiRequest(e,t={},n=!0){let o=storage.getToken();if(o&&isTokenExpired(o,300)){const e=await refreshTokenWithSession();e&&(o=e)}const s={headers:{"Content-Type":"application/json",...o&&{Authorization:`Bearer ${o}`},...t.headers},...t};try{const o=await fetch(`${AUTH_API_URL}${e}`,s),r=await o.json();if(!o.ok){if((401===o.status||403===o.status)&&n&&storage.getSessionToken()){const n=(r.error||"").toLowerCase();if(n.includes("expired")||n.includes("invalid token")){if(await refreshTokenWithSession())return apiRequest(e,t,!1)}}throw new Error(r.error||"Request failed")}return r}catch(e){throw Logger.error("API Request Error:",e),e}}const AuthAPI={register:async(e,t)=>{const n=await apiRequest("/auth/register",{method:"POST",body:JSON.stringify({username:e,email:t})});return n.tempToken&&(storage.setTempToken(n.tempToken),storage.setTempEmail(t)),n},verifyEmail:async(e,t)=>{const n=await apiRequest("/auth/verify-email",{method:"POST",body:JSON.stringify({email:e,code:t})});return n.token&&(storage.setToken(n.token),storage.setUser(n.user),n.sessionToken&&storage.setSessionToken(n.sessionToken),storage.removeTempToken(),storage.removeTempEmail()),n},login:async e=>{const t=await apiRequest("/auth/login",{method:"POST",body:JSON.stringify({email:e})});return t.tempToken&&(storage.setTempToken(t.tempToken),storage.setTempEmail(e)),t},verifyLoginCode:async(e,t=!1)=>{const n=storage.getTempToken();if(!n)throw new Error("No verification session found");const o=await apiRequest("/auth/verify-login",{method:"POST",body:JSON.stringify({tempToken:n,code:e,rememberMe:t})});return o.token&&(storage.setToken(o.token),storage.setUser(o.user),o.sessionToken&&storage.setSessionToken(o.sessionToken),storage.removeTempToken(),storage.removeTempEmail()),o},verifyLogin:async(e,t=!1)=>AuthAPI.verifyLoginCode(e,t),resendVerification:async(e,t="registration")=>await apiRequest("/auth/resend-verification",{method:"POST",body:JSON.stringify({email:e,type:t})}),logout:async()=>{try{const e=storage.getSessionToken();await apiRequest("/auth/logout",{method:"POST",body:JSON.stringify({sessionToken:e})})}catch(e){Logger.error("Logout error:",e)}finally{storage.clearAll()}},checkAuth:async()=>{try{const e=await apiRequest("/auth/me");return e.user&&storage.setUser(e.user),e}catch(e){throw e}},checkEmail:async e=>(await apiRequest(`/auth/check-email?email=${encodeURIComponent(e)}`)).available,checkUsername:async e=>(await apiRequest(`/auth/check-username?username=${encodeURIComponent(e)}`)).available,getCurrentUser:()=>{const e=storage.getToken();if(!e)return Logger.warn("[WARN] No auth token found"),null;const t=decodeJWT(e);if(!t)return Logger.warn("[WARN] Invalid JWT token format"),storage.getUser();const n=storage.getUser();return{id:t.userId,username:t.username,email:t.email,role:t.role||"free",subscription_tier:t.subscription_tier||"free",...n||{}}},isLoggedIn:()=>{const e=storage.getToken();if(!e)return!1;if(isTokenExpired(e,0)){return!!storage.getSessionToken()||(storage.clearAll(),!1)}return!0},forceRefresh:async()=>{const e=await refreshTokenWithJWT();return e||await refreshTokenWithSession()},refreshWithJWT:async()=>await refreshTokenWithJWT(),refreshWithSession:async()=>await refreshTokenWithSession(),getTokenInfo:()=>{const e=storage.getToken();if(!e)return null;const t=decodeJWT(e);if(!t)return null;const n=getTokenTimeRemaining(e);return{expiresAt:t.exp?new Date(1e3*t.exp):null,remainingSeconds:n,remainingMinutes:Math.floor(n/60),remainingHours:Math.floor(n/3600),isExpired:n<=0,hasSessionToken:!!storage.getSessionToken()}}};let backgroundRefreshInterval=null;function setupBackgroundRefresh(){backgroundRefreshInterval&&clearInterval(backgroundRefreshInterval),backgroundRefreshInterval=setInterval(async()=>{const e=storage.getToken(),t=storage.getSessionToken();if(!e||!t)return;const n=getTokenTimeRemaining(e);n>0&&n<300&&await refreshTokenWithSession()},6e4)}function stopBackgroundRefresh(){backgroundRefreshInterval&&(clearInterval(backgroundRefreshInterval),backgroundRefreshInterval=null)}"undefined"!=typeof window&&(storage.getToken()&&storage.getSessionToken()&&setupBackgroundRefresh(),window.addEventListener("storage",e=>{"auth_token"!==e.key&&"session_token"!==e.key||(storage.getToken()&&storage.getSessionToken()?setupBackgroundRefresh():stopBackgroundRefresh())}));const Auth={...AuthAPI,storage:storage,isTokenExpired:isTokenExpired,getTokenTimeRemaining:getTokenTimeRemaining,refreshTokenWithSession:refreshTokenWithSession,refreshTokenWithJWT:refreshTokenWithJWT,setupBackgroundRefresh:setupBackgroundRefresh,stopBackgroundRefresh:stopBackgroundRefresh};"undefined"!=typeof window&&(window.Auth=Auth,window.AuthAPI=AuthAPI),function(){function e(){var e=localStorage.getItem("auth_token")||localStorage.getItem("accessToken")||localStorage.getItem("token");if(!e)return!1;try{var t=JSON.parse(atob(e.split(".")[1])),n=Math.floor(Date.now()/1e3);return!(t.exp&&t.exp<n)}catch(e){return!1}}function t(){var e=localStorage.getItem("auth_token")||localStorage.getItem("accessToken")||localStorage.getItem("token");if(!e)return null;try{var t=JSON.parse(atob(e.split(".")[1]));return{id:t.userId,username:t.username,email:t.email,role:t.role||"free",subscription_tier:t.subscription_tier||"free"}}catch(e){return null}}async function n(e){for(var t=Date.now();Date.now()-t<e;){if(void 0!==Auth&&Auth.isLoggedIn)return!0;await new Promise(function(e){setTimeout(e,50)})}return!1}async function o(){return await n(1500)?Auth.isLoggedIn():e()}async function s(){return await n(1500)&&Auth.getCurrentUser?Auth.getCurrentUser():t()}async function r(e){return await o()?await s():(window.location.href=e||"/login",null)}window.AuthHelper={isLoggedIn:o,getCurrentUser:s,requireLogin:r,requireAdmin:async function(e){var t=await r("/login");return t?"admin"!==t.role?(window.location.href=e||"/dashboard",null):t:null},hasValidToken:e,getUserFromToken:t}}();let authInitialized=!1;const TIER_ICONS="undefined"!=typeof CONFIG&&CONFIG.ICONS&&CONFIG.ICONS.TIERS?CONFIG.ICONS.TIERS:{free:"‚ôü",basic:"‚ôô",premium:"‚ôò",elite:"‚ôî",admin:"üëë"};function getPageContext(){const e=window.location.pathname,t="/"===e||"/index.html"===e||""===e,n=e.includes("/dashboard"),o=t||n;return{isHomepage:t,isDashboard:n,isProtectedPage:o,showModernChess:o,showUserMenu:o,backButton:{href:"/dashboard",text:t?"Dashboard":"Back to Dashboard",icon:t?"üìä":"‚Üê"}}}function ensureNavRight(){const e=document.querySelector(".nav-container");if(!e)return null;let t=e.querySelector(".nav-right");return t||(t=document.createElement("div"),t.className="nav-right",t.style.cssText="display: flex; align-items: center; gap: 12px;",e.appendChild(t)),t}function moveOrphanElements(e){const t=document.querySelector(".nav-container");if(!t||!e)return;t.querySelectorAll(':scope > .back-button, :scope > .dashboard-button, :scope > a[href="/dashboard"]:not(.logo-container)').forEach(t=>{t.classList.contains("logo-container")||t.classList.contains("logo-section")||e.appendChild(t)})}function ensureBackButton(e){const t=getPageContext();let n=e.querySelector(".back-button, .dashboard-button, .scp-back-button");n||(n=document.createElement("a"),n.className="dashboard-button scp-back-button"),n.href=t.backButton.href,n.innerHTML=`<span class="dashboard-icon">${SafeHTML.escapeText(t.backButton.icon)}</span><span>${SafeHTML.escapeText(t.backButton.text)}</span>`;const o=e.querySelector(".user-menu-button");return o?e.insertBefore(n,o):e.contains(n)||e.insertBefore(n,e.firstChild),n}function ensureUserMenu(e){const t=getPageContext();let n=e.querySelector(".user-menu-button");if(!t.showUserMenu)return n&&n.remove(),null;if(n||(n=document.createElement("div"),n.className="user-menu-button",SafeHTML.setHTML(n,'\n      <div class="user-avatar">üë§</div>\n      <span class="user-name" id="userName">User</span>\n      <span class="menu-arrow">‚ñº</span>\n    '),e.appendChild(n)),e.lastChild!==n&&e.appendChild(n),!n.dataset.scpHooked){n.dataset.scpHooked="true",n.removeAttribute("onclick"),n.style.cursor="pointer",n.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),toggleScpDropdown(n)});const e=n.querySelector(".user-dropdown");e&&(e.style.display="none")}return n}function ensureAuthButtons(e){const t=e.querySelector(".auth-buttons");t&&t.remove();const n=document.createElement("div");n.className="auth-buttons",n.style.cssText="display: flex; gap: 12px; align-items: center;",SafeHTML.setHTML(n,'\n    <a href="/login" class="auth-btn login-btn" style="\n      color: #ff8c00;\n      text-decoration: none;\n      font-size: 14px;\n      font-weight: 600;\n      padding: 10px 20px;\n      border: 2px solid #ff8c00;\n      border-radius: 25px;\n      transition: all 0.3s;\n      background: transparent;\n    ">Login</a>\n    <a href="/register" class="auth-btn register-btn" style="\n      background: linear-gradient(45deg, #ff8c00, #ff6347);\n      color: #000;\n      text-decoration: none;\n      font-size: 14px;\n      font-weight: 700;\n      padding: 10px 20px;\n      border: none;\n      border-radius: 25px;\n      transition: all 0.3s;\n    ">Sign Up</a>\n  ');const o=n.querySelector(".login-btn"),s=n.querySelector(".register-btn");return o&&(o.addEventListener("mouseenter",()=>{o.style.background="rgba(255, 140, 0, 0.1)",o.style.transform="scale(1.05)"}),o.addEventListener("mouseleave",()=>{o.style.background="transparent",o.style.transform="scale(1)"})),s&&(s.addEventListener("mouseenter",()=>{s.style.transform="translateY(-2px)",s.style.boxShadow="0 10px 25px rgba(255, 140, 0, 0.4)"}),s.addEventListener("mouseleave",()=>{s.style.transform="translateY(0)",s.style.boxShadow="none"})),e.appendChild(n),n}function buildHeader(){const e=ensureNavRight();if(!e)return;const t=getPageContext();if(!Auth.isLoggedIn()){const t=e.querySelector(".user-menu-button");t&&t.remove();const n=e.querySelector(".dashboard-button, .scp-back-button");return n&&n.remove(),void ensureAuthButtons(e)}const n=e.querySelector(".auth-buttons");n&&n.remove(),moveOrphanElements(e),ensureBackButton(e),ensureUserMenu(e);const o=Auth.getCurrentUser();o&&t.showUserMenu&&document.querySelectorAll(".user-name, #userName").forEach(e=>{e.textContent=o.username})}function createScpDropdown(){if(!getPageContext().showUserMenu)return;if(document.getElementById("scpUserDropdown"))return;document.body.insertAdjacentHTML("beforeend",'\n    <div id="scpUserDropdown" class="scp-user-dropdown">\n      <div class="scp-dropdown-header">\n        <div class="scp-dropdown-avatar">üë§</div>\n        <div class="scp-dropdown-info">\n          <div class="scp-dropdown-name" id="scpUsernameDisplay">Username</div>\n          <div class="scp-dropdown-email" id="scpEmailDisplay">email@example.com</div>\n        </div>\n      </div>\n      <div class="scp-subscription-box">\n        <div class="scp-subscription-header">\n          <div class="scp-subscription-tier">\n            <span class="scp-tier-icon" id="scpSubTierIcon">‚ôü</span>\n            <span class="scp-tier-name" id="scpSubTierName">Free</span>\n          </div>\n          <span class="scp-subscription-status" id="scpSubStatus">ACTIVE</span>\n        </div>\n        <div class="scp-subscription-days" id="scpSubDaysContainer">\n          <span class="scp-days-label">Days remaining</span>\n          <span class="scp-days-value" id="scpSubDaysValue">-</span>\n        </div>\n        <div class="scp-subscription-progress" id="scpSubProgressContainer">\n          <div class="scp-subscription-progress-bar" id="scpSubProgressBar" style="width: 0%;"></div>\n        </div>\n        <button class="scp-btn-manage-subscription" onclick="window.location.href=\'/subscription\'">Manage Subscription</button>\n      </div>\n      <div class="scp-dropdown-divider"></div>\n      <div class="scp-dropdown-menu">\n        <a href="/dashboard" class="scp-dropdown-item">\n          <span class="scp-dropdown-icon">üìä</span>\n          <div class="scp-dropdown-item-text">\n            <span class="scp-dropdown-item-label">Dashboard</span>\n            <span class="scp-dropdown-item-desc">Your overview</span>\n          </div>\n        </a>\n        <a href="/admin" class="scp-dropdown-item" id="scpAdminPanelLink" style="display: none;">\n          <span class="scp-dropdown-icon">‚öôÔ∏è</span>\n          <div class="scp-dropdown-item-text">\n            <span class="scp-dropdown-item-label">Admin Panel</span>\n            <span class="scp-dropdown-item-desc">Manage content</span>\n          </div>\n        </a>\n        <a href="/subscription" class="scp-dropdown-item">\n          <span class="scp-dropdown-icon">üíé</span>\n          <div class="scp-dropdown-item-text">\n            <span class="scp-dropdown-item-label">Upgrade Plan</span>\n            <span class="scp-dropdown-item-desc">Get more features</span>\n          </div>\n        </a>\n      </div>\n      <div class="scp-dropdown-divider"></div>\n      <div class="scp-logout-item">\n        <a href="#" onclick="handleLogout(); return false;" class="scp-dropdown-item scp-logout-link">\n          <span class="scp-dropdown-icon">üö™</span>\n          <span class="scp-dropdown-item-label">Logout</span>\n        </a>\n      </div>\n    </div>\n  ')}function toggleScpDropdown(e){const t=document.getElementById("scpUserDropdown");if(t)if(t.classList.contains("open"))t.classList.remove("open");else{const n=e.getBoundingClientRect();t.style.top=n.bottom+10+"px",t.style.right=window.innerWidth-n.right+"px",t.classList.add("open")}}function createAuthModals(){if(document.getElementById("authModalOverlay"))return;document.body.insertAdjacentHTML("beforeend",'\n    <div id="authModalOverlay" class="auth-modal-overlay">\n      <div id="loginModal" class="auth-modal">\n        <div class="modal-header">\n          <h2 class="modal-title">Welcome Back</h2>\n          <button class="modal-close" onclick="closeAuthModal()">&times;</button>\n        </div>\n        <div class="error-message" id="loginError"></div>\n        <div class="success-message" id="loginSuccess"></div>\n        <form id="modalLoginForm" class="modal-form">\n          <div class="form-group">\n            <label class="form-label">Email Address</label>\n            <input type="email" class="form-input" id="loginEmail" required placeholder="Enter your email">\n          </div>\n          <button type="submit" class="form-button" id="loginSubmitBtn">üìß Send Login Code</button>\n          <div class="form-link">Don\'t have an account? <a href="#" onclick="switchToRegister()">Create one</a></div>\n        </form>\n        <div id="loginCodeContainer" class="code-container" style="display: none;">\n          <p style="text-align: center; color: #ffbfaa; margin-bottom: 10px;">Enter the 5-digit code sent to your email</p>\n          <p style="text-align: center; color: #ff8c00; font-weight: 600; margin-bottom: 20px;" id="loginEmailDisplay"></p>\n          <form id="loginVerifyForm">\n            <div class="code-inputs">\n              <input type="text" class="code-input" maxlength="1" id="loginCode1">\n              <input type="text" class="code-input" maxlength="1" id="loginCode2">\n              <input type="text" class="code-input" maxlength="1" id="loginCode3">\n              <input type="text" class="code-input" maxlength="1" id="loginCode4">\n              <input type="text" class="code-input" maxlength="1" id="loginCode5">\n            </div>\n            <div class="form-checkbox" style="margin: 20px 0;">\n              <input type="checkbox" id="loginRememberMe">\n              <label for="loginRememberMe">Remember me</label>\n            </div>\n            <button type="submit" class="form-button" id="loginVerifyBtn">Verify & Login</button>\n            <div class="resend-link">Didn\'t receive code? <a href="#" onclick="resendLoginCode(); return false;">Resend</a></div>\n          </form>\n        </div>\n      </div>\n      <div id="registerModal" class="auth-modal" style="display: none;">\n        <div class="modal-header">\n          <h2 class="modal-title">Create Account</h2>\n          <button class="modal-close" onclick="closeAuthModal()">&times;</button>\n        </div>\n        <div class="error-message" id="registerError"></div>\n        <div class="success-message" id="registerSuccess"></div>\n        <form id="modalRegisterForm" class="modal-form">\n          <div class="form-group">\n            <label class="form-label">Username</label>\n            <input type="text" class="form-input" id="registerUsername" required minlength="4" maxlength="20" placeholder="Choose a username">\n            <p class="password-hint">4-20 characters, letters and numbers only</p>\n          </div>\n          <div class="form-group">\n            <label class="form-label">Email Address</label>\n            <input type="email" class="form-input" id="registerEmail" required placeholder="Enter your email">\n          </div>\n          <button type="submit" class="form-button" id="registerSubmitBtn">üéâ Create Account</button>\n          <div class="form-link">Already have an account? <a href="#" onclick="switchToLogin()">Login</a></div>\n        </form>\n        <div id="registerCodeContainer" class="code-container" style="display: none;">\n          <p style="text-align: center; color: #ffbfaa; margin-bottom: 10px;">Enter the 5-digit code sent to your email</p>\n          <p style="text-align: center; color: #ff8c00; font-weight: 600; margin-bottom: 10px;" id="registerEmailDisplay"></p>\n          <p class="expiry-notice">Code expires in 3 minutes</p>\n          <form id="registerVerifyForm">\n            <div class="code-inputs">\n              <input type="text" class="code-input" maxlength="1" id="registerCode1">\n              <input type="text" class="code-input" maxlength="1" id="registerCode2">\n              <input type="text" class="code-input" maxlength="1" id="registerCode3">\n              <input type="text" class="code-input" maxlength="1" id="registerCode4">\n              <input type="text" class="code-input" maxlength="1" id="registerCode5">\n            </div>\n            <button type="submit" class="form-button" id="registerVerifyBtn">Verify & Continue</button>\n            <div class="resend-link">Didn\'t receive code? <a href="#" onclick="resendRegisterCode(); return false;">Resend</a></div>\n          </form>\n        </div>\n      </div>\n    </div>\n  ')}function setupEventListeners(){const e=document.getElementById("modalLoginForm");e&&e.addEventListener("submit",handleLogin);const t=document.getElementById("loginVerifyForm");t&&t.addEventListener("submit",handleLoginVerify);const n=document.getElementById("modalRegisterForm");n&&n.addEventListener("submit",handleRegister);const o=document.getElementById("registerVerifyForm");o&&o.addEventListener("submit",handleRegisterVerify)}async function initializeAuth(){authInitialized||(void 0!==Auth&&void 0!==AuthAPI?(createAuthModals(),createScpDropdown(),setupEventListeners(),buildHeader(),await updateAuthUI(),authInitialized=!0):setTimeout(initializeAuth,100))}function openLoginModal(){document.getElementById("authModalOverlay").style.display="flex",document.getElementById("loginModal").style.display="block",document.getElementById("registerModal").style.display="none",document.getElementById("modalLoginForm").style.display="block",document.getElementById("loginCodeContainer").style.display="none",clearMessages()}function openRegisterModal(){document.getElementById("authModalOverlay").style.display="flex",document.getElementById("registerModal").style.display="block",document.getElementById("loginModal").style.display="none",document.getElementById("modalRegisterForm").style.display="block",document.getElementById("registerCodeContainer").style.display="none",clearMessages()}function closeAuthModal(){document.getElementById("authModalOverlay").style.display="none",document.getElementById("modalLoginForm")?.reset(),document.getElementById("modalRegisterForm")?.reset(),document.getElementById("modalLoginForm").style.display="block",document.getElementById("loginCodeContainer").style.display="none",document.getElementById("modalRegisterForm").style.display="block",document.getElementById("registerCodeContainer").style.display="none",clearMessages()}function switchToRegister(){document.getElementById("loginModal").style.display="none",document.getElementById("registerModal").style.display="block",clearMessages()}function switchToLogin(){document.getElementById("registerModal").style.display="none",document.getElementById("loginModal").style.display="block",clearMessages()}function showPopupNotification(e,t="success"){const n=document.getElementById("popupNotification");n&&(document.getElementById("popupIcon").textContent="success"===t?"‚úÖ":"‚ùå",n.className=`popup-notification popup-${t}`,document.getElementById("popupMessage").textContent=e,n.classList.add("show"),setTimeout(()=>n.classList.remove("show"),4e3))}function showError(e,t){const n=document.getElementById(e);n&&(n.textContent=t,n.classList.add("show"),setTimeout(()=>n.classList.remove("show"),7e3))}function showSuccess(e,t){const n=document.getElementById(e);n&&(n.textContent=t,n.classList.add("show"),setTimeout(()=>n.classList.remove("show"),5e3))}function clearMessages(){["loginError","loginSuccess","registerError","registerSuccess"].forEach(e=>{document.getElementById(e)?.classList.remove("show")})}function clearInlineErrors(){document.querySelectorAll(".inline-error").forEach(e=>e.remove())}async function fetchSubscriptionStatus(){try{const e="undefined"!=typeof CONFIG?CONFIG.API.PAYMENT:"https://payments.superchessprep.com",t=Auth.storage.getToken();if(!t)return null;const n=await fetch(`${e}/api/subscription/status`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},credentials:"include"});if(!n.ok)return null;const o=await n.json();return o.success&&o.subscription?o.subscription:null}catch(e){return null}}function updateSubscriptionUI(e){if(!getPageContext().showUserMenu)return;const t=document.getElementById("scpSubTierIcon"),n=document.getElementById("scpSubTierName"),o=document.getElementById("scpSubStatus"),s=document.getElementById("scpSubDaysContainer"),r=document.getElementById("scpSubDaysValue"),i=document.getElementById("scpSubProgressContainer"),a=document.getElementById("scpSubProgressBar");if(!e)return t&&(t.textContent=TIER_ICONS.free),n&&(n.textContent="Free"),o&&(o.textContent="FREE",o.className="scp-subscription-status free"),s&&(s.style.display="none"),void(i&&(i.style.display="none"));const c=e.tier||"free";if(t&&(t.textContent=TIER_ICONS[c]||TIER_ICONS.free),n&&(n.textContent=c.charAt(0).toUpperCase()+c.slice(1)),o&&("free"===c?(o.textContent="FREE",o.className="scp-subscription-status free"):"canceling"===e.status?(o.textContent="CANCELING",o.className="scp-subscription-status canceling"):(o.textContent="ACTIVE",o.className="scp-subscription-status")),"free"!==c&&e.expiresAt){const t=Math.max(0,Math.ceil((new Date(e.expiresAt)-new Date)/864e5));s&&(s.style.display="flex"),r&&(r.textContent=`${t} days`),i&&(i.style.display="block"),a&&(a.style.width=`${Math.min(100,t/30*100)}%`)}else s&&(s.style.display="none"),i&&(i.style.display="none")}async function updateAuthUI(){const e=getPageContext();if(!Auth.isLoggedIn())return;const t=Auth.getCurrentUser();if(t&&e.showUserMenu){const e=document.getElementById("scpUsernameDisplay"),n=document.getElementById("scpEmailDisplay");if(e&&(e.textContent=t.username),n&&(n.textContent=t.email),document.querySelectorAll(".user-name, #userName").forEach(e=>e.textContent=t.username),"admin"===t.role||"admin"===t.tier){const e=document.getElementById("scpAdminPanelLink");e&&(e.style.display="flex")}}updateSubscriptionUI(await fetchSubscriptionStatus())}function setupCodeInputs(e){for(let t=1;t<=5;i++){const n=document.getElementById(`${e}Code${i}`);n&&(n.addEventListener("input",function(){1===this.value.length&&t<5&&document.getElementById(`${e}Code${i+1}`).focus()}),n.addEventListener("keydown",function(n){"Backspace"===n.key&&""===this.value&&t>1&&document.getElementById(`${e}Code${i-1}`).focus()}))}}window.toggleScpDropdown=toggleScpDropdown,document.addEventListener("click",function(e){const t=document.getElementById("scpUserDropdown");!t||e.target.closest(".user-menu-button")||e.target.closest(".scp-user-dropdown")||t.classList.remove("open")}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeAuth):initializeAuth(),document.addEventListener("click",e=>{const t=document.getElementById("authModalOverlay");e.target===t&&closeAuthModal()});let tempLoginEmail="";async function handleLogin(e){e.preventDefault(),clearMessages(),clearInlineErrors();const t=document.getElementById("loginEmail").value.trim();tempLoginEmail=t;const n=document.getElementById("loginSubmitBtn");n.disabled=!0,n.textContent="Sending...";try{const e=await AuthAPI.login(t);e.success&&e.tempToken&&(document.getElementById("modalLoginForm").style.display="none",document.getElementById("loginCodeContainer").style.display="block",document.getElementById("loginEmailDisplay").textContent=t,document.getElementById("loginCode1").focus(),showSuccess("loginSuccess","Code sent!"),setupCodeInputs("login"))}catch(e){showPopupNotification(e.message||"Failed","error"),showError("loginError",e.message)}finally{n.disabled=!1,n.textContent="üìß Send Login Code"}}async function handleLoginVerify(e){e.preventDefault(),clearMessages();const t=[1,2,3,4,5].map(e=>document.getElementById(`loginCode${e}`).value).join("");if(5!==t.length)return void showError("loginError","Enter all 5 digits");const n=document.getElementById("loginRememberMe").checked,o=document.getElementById("loginVerifyBtn");o.disabled=!0,o.textContent="Verifying...";try{(await AuthAPI.verifyLoginCode(t,n)).success&&(closeAuthModal(),showPopupNotification("Logged in!","success"),await updateAuthUI(),setTimeout(()=>location.href="/dashboard",1e3))}catch(e){showPopupNotification(e.message||"Failed","error"),showError("loginError",e.message),[1,2,3,4,5].forEach(e=>document.getElementById(`loginCode${e}`).value=""),document.getElementById("loginCode1").focus(),o.disabled=!1,o.textContent="Verify & Login"}}async function resendLoginCode(){try{const e=Auth.storage.getTempEmail();if(!e)return void showError("loginError","Session expired");await Auth.resendVerification(e,"login"),showSuccess("loginSuccess","New code sent!")}catch(e){showError("loginError",e.message)}}let tempRegisterEmail="";async function handleRegister(e){e.preventDefault(),clearMessages(),clearInlineErrors();const t=document.getElementById("registerUsername").value.trim(),n=document.getElementById("registerEmail").value.trim();if(!/^[a-zA-Z0-9]+$/.test(t))return void showError("registerError","Letters and numbers only");tempRegisterEmail=n;const o=document.getElementById("registerSubmitBtn");o.disabled=!0,o.textContent="Creating...";try{const e=await AuthAPI.register(t,n);e.success&&e.tempToken&&(document.getElementById("modalRegisterForm").style.display="none",document.getElementById("registerCodeContainer").style.display="block",document.getElementById("registerEmailDisplay").textContent=n,document.getElementById("registerCode1").focus(),showSuccess("registerSuccess","Code sent!"),setupCodeInputs("register"))}catch(e){showPopupNotification(e.message||"Failed","error"),showError("registerError",e.message)}finally{o.disabled=!1,o.textContent="üéâ Create Account"}}async function handleRegisterVerify(e){e.preventDefault(),clearMessages();const t=[1,2,3,4,5].map(e=>document.getElementById(`registerCode${e}`).value).join("");if(5!==t.length)return void showError("registerError","Enter all 5 digits");const n=document.getElementById("registerVerifyBtn");n.disabled=!0,n.textContent="Verifying...";try{(await AuthAPI.verifyEmail(tempRegisterEmail,t)).success&&(closeAuthModal(),showPopupNotification("Welcome!","success"),await updateAuthUI(),setTimeout(()=>location.href="/dashboard",1e3))}catch(e){showPopupNotification(e.message||"Failed","error"),showError("registerError",e.message),[1,2,3,4,5].forEach(e=>document.getElementById(`registerCode${e}`).value=""),document.getElementById("registerCode1").focus(),n.disabled=!1,n.textContent="Verify & Continue"}}async function resendRegisterCode(){try{await AuthAPI.resendVerification(tempRegisterEmail),showSuccess("registerSuccess","New code sent!")}catch(e){showError("registerError",e.message)}}async function handleLogout(){document.getElementById("scpUserDropdown")?.classList.remove("open");try{await AuthAPI.logout(),showPopupNotification("Logged out!","success"),setTimeout(()=>location.href="/",1e3)}catch(e){showPopupNotification("Failed","error")}}function fixLoggedInHeader(){const e=document.querySelector(".nav-right");if(!e)return;const t=e.querySelector(".partner-logo")||document.querySelector(".nav-container > .partner-logo"),n=e.querySelector(".dashboard-button, .scp-back-button"),o=e.querySelector(".user-menu-button"),s=e.querySelector(".auth-buttons");t&&!e.contains(t)&&e.insertBefore(t,e.firstChild);const r=[];t&&r.push(t),n&&r.push(n),o&&r.push(o),s&&r.push(s),r.forEach(e=>{e&&e.parentNode&&e.remove()}),r.forEach(t=>{t&&e.appendChild(t)})}function ensureModalOverlay(){let e=document.getElementById("customModalOverlay");return e||(e=document.createElement("div"),e.id="customModalOverlay",e.className="custom-modal-overlay",document.body.appendChild(e)),e}function customAlert(e,t="Information",n="info"){return new Promise(o=>{const s=ensureModalOverlay(),r={success:"‚úÖ",error:"‚ùå",warning:"‚ö†Ô∏è",info:"‚ÑπÔ∏è"},i=r[n]||r.info,a=s.cloneNode(!1);s.parentNode.replaceChild(a,s);const c=a;c.innerHTML=`\n      <div class="custom-modal-box ${n}">\n        <div class="custom-modal-header">\n          <span class="custom-modal-icon">${i}</span>\n          <h2 class="custom-modal-title">${t}</h2>\n        </div>\n        <div class="custom-modal-content">\n          ${e}\n        </div>\n        <div class="custom-modal-footer">\n          <button class="custom-modal-btn custom-modal-btn-ok">OK</button>\n        </div>\n      </div>\n    `,c.classList.add("active");const l=()=>{c.classList.remove("active"),setTimeout(()=>{c.innerHTML=""},300),o(!0)},d=c.querySelector(".custom-modal-btn-ok");d.addEventListener("click",l,{once:!0}),c.addEventListener("click",e=>{e.target===c&&l()},{once:!0});const u=e=>{"Escape"===e.key&&(l(),document.removeEventListener("keydown",u))};document.addEventListener("keydown",u),setTimeout(()=>d.focus(),100)})}function customConfirm(e,t="Confirmation",n={}){return new Promise(o=>{const s=ensureModalOverlay(),{confirmText:r="OK",cancelText:i="Cancel",type:a="warning"}=n,c=s.cloneNode(!1);s.parentNode.replaceChild(c,s);const l=c;l.innerHTML=`\n      <div class="custom-modal-box ${a}">\n        <div class="custom-modal-header">\n          <span class="custom-modal-icon">‚ö†Ô∏è</span>\n          <h2 class="custom-modal-title">${t}</h2>\n        </div>\n        <div class="custom-modal-content">\n          ${e}\n        </div>\n        <div class="custom-modal-footer">\n          <button class="custom-modal-btn custom-modal-btn-cancel">${i}</button>\n          <button class="custom-modal-btn custom-modal-btn-confirm">${r}</button>\n        </div>\n      </div>\n    `,l.classList.add("active");const d=e=>{l.classList.remove("active"),setTimeout(()=>{l.innerHTML=""},300),document.removeEventListener("keydown",p),o(e)},u=l.querySelector(".custom-modal-btn-cancel"),m=l.querySelector(".custom-modal-btn-confirm");u.addEventListener("click",()=>d(!1),{once:!0}),m.addEventListener("click",()=>d(!0),{once:!0}),l.addEventListener("click",e=>{e.target===l&&d(!1)},{once:!0});const p=e=>{"Escape"===e.key&&d(!1)};document.addEventListener("keydown",p),setTimeout(()=>m.focus(),100)})}function showSuccess(e,t="Success"){return customAlert(e,t,"success")}function showError(e,t="Error"){return customAlert(e,t,"error")}function showWarning(e,t="Warning"){return customAlert(e,t,"warning")}function confirmDelete(e="this item"){return customConfirm(`Are you sure you want to delete ${e}?<br><br><strong>This action cannot be undone.</strong>`,"Delete Confirmation",{confirmText:"Delete",cancelText:"Cancel",type:"warning"})}function confirmClose(e="this topic"){return customConfirm(`Are you sure you want to close ${e}?`,"Close Confirmation",{confirmText:"Close",cancelText:"Cancel",type:"warning"})}function confirmOpen(e="this topic"){return customConfirm(`Are you sure you want to reopen ${e}?`,"Reopen Confirmation",{confirmText:"Reopen",cancelText:"Cancel",type:"info"})}!function(){var e=document.createElement("style");e.textContent=".nav-right, .nav-right::before, .nav-right::after { border:none!important; outline:none!important; box-shadow:none!important; }",document.head.appendChild(e)}(),function(){"use strict";function e(){const e=document.querySelector(".nav-container");if(!e)return null;let t=e.querySelector(".nav-right");return t||(t=document.createElement("div"),t.className="nav-right",e.appendChild(t)),t}function t(){const t=e(),n=document.querySelector(".partner-logo");t&&n&&(t.contains(n)||t.insertBefore(n,t.firstChild),function(e){if(!e)return;const t=e.querySelector(".partner-logo"),n=e.querySelector(".dashboard-button, .scp-back-button, .back-button"),o=e.querySelector(".user-menu-button"),s=e.querySelector(".auth-buttons"),r=[t,n,o||s].filter(Boolean);r.forEach(e=>e.remove()),r.forEach(t=>e.appendChild(t))}(t))}function n(){e(),t()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{n(),setTimeout(t,500)}):(n(),setTimeout(t,500)),window.HeaderComponent={init:n,fixOrder:t}}(),setTimeout(fixLoggedInHeader,800),window.addEventListener("load",()=>setTimeout(fixLoggedInHeader,200)),function(){"use strict";const e=50,t=100;let n,o,s,r,i=!1,a=0,c=0;function l(){n=document.getElementById("hamburgerBtn"),o=document.getElementById("mobileDrawer"),s=document.getElementById("drawerOverlay"),r=document.getElementById("bottomNav"),(n||o||r)&&(!function(){if(!n||!o)return;n.addEventListener("click",d),s&&s.addEventListener("click",m);o.querySelectorAll(".drawer-nav-item").forEach(e=>{e.addEventListener("click",()=>setTimeout(m,150))}),document.addEventListener("keydown",e=>{"Escape"===e.key&&i&&m()})}(),document.addEventListener("touchstart",e=>{a=e.touches[0].clientX},{passive:!0}),document.addEventListener("touchend",n=>{c=n.changedTouches[0].clientX,!i&&a<e&&c-a>t&&u()},{passive:!0}),o&&(o.addEventListener("touchstart",e=>{a=e.touches[0].clientX},{passive:!0}),o.addEventListener("touchend",e=>{c=e.changedTouches[0].clientX,i&&a-c>t&&m()},{passive:!0})),function(){if(!r)return;r.querySelectorAll(".bottom-nav-item").forEach(e=>{e.addEventListener("click",t=>function(e,t){const n=document.createElement("span"),o=e.getBoundingClientRect(),s=Math.max(o.width,o.height);n.style.cssText=`\n      position: absolute;\n      width: ${s}px; height: ${s}px;\n      left: ${t.clientX-o.left-s/2}px;\n      top: ${t.clientY-o.top-s/2}px;\n      background: rgba(255, 140, 0, 0.3);\n      border-radius: 50%;\n      transform: scale(0);\n      animation: ripple 0.6s ease-out;\n      pointer-events: none;\n    `,e.style.position="relative",e.style.overflow="hidden",e.appendChild(n),setTimeout(()=>n.remove(),600)}(e,t))})}(),p(),g())}function d(){i?m():u()}function u(){o&&(i=!0,o.classList.add("open"),s&&s.classList.add("open"),n&&(n.classList.add("open"),n.setAttribute("aria-expanded","true")),document.body.style.overflow="hidden")}function m(){o&&(i=!1,o.classList.remove("open"),s&&s.classList.remove("open"),n&&(n.classList.remove("open"),n.setAttribute("aria-expanded","false")),document.body.style.overflow="")}function p(){const e={"/":"home","/index":"home","/index.html":"home","/dashboard":"dashboard","/dashboard.html":"dashboard","/all-courses":"courses","/all-courses.html":"courses","/videos":"videos","/videos.html":"videos","/daily-exercises":"exercises","/daily-exercises.html":"exercises","/community-discussions":"forum","/community-discussions.html":"forum","/news":"news","/news.html":"news","/shop":"shop","/shop.html":"shop","/login":"login","/login.html":"login","/register":"register","/register.html":"register","/admin":"admin-panel","/admin/pgn":"admin-pgn","/admin/videos":"admin-videos","/admin/forum":"admin-forum","/admin/news":"admin-news"}[window.location.pathname.replace(/\/$/,"")||"/"]||"";r&&r.querySelectorAll(".bottom-nav-item").forEach(t=>{const n=t.getAttribute("data-page");t.classList.toggle("active",n===e)}),o&&o.querySelectorAll(".drawer-nav-item").forEach(t=>{const n=t.getAttribute("data-page");t.classList.toggle("active",n===e)})}function g(){const e=void 0!==Auth&&Auth.isLoggedIn&&Auth.isLoggedIn(),t=document.getElementById("drawerUserSection"),n=document.getElementById("drawerNavSection"),o=document.getElementById("drawerAdminSection"),s=document.getElementById("drawerLoginSection"),r=document.getElementById("drawerLogoutBtn"),i=document.getElementById("bottomNav");if(e){const e=Auth.getCurrentUser();t&&(t.style.display="block"),n&&(n.style.display="block"),s&&(s.style.display="none"),r&&(r.style.display="flex"),i&&(i.style.display="");const a=document.getElementById("drawerUsername"),c=document.getElementById("drawerEmail"),l=document.getElementById("drawerTierBadge"),d=document.getElementById("drawerTierIcon"),u=document.getElementById("drawerTierText");a&&e&&(a.textContent=e.username||"User"),c&&e&&(c.textContent=e.email||"");const m=e?.tier||e?.subscription_tier||"free",p={free:{icon:"‚≠ê",name:"Free"},basic:{icon:"‚ôüÔ∏è",name:"Basic"},premium:{icon:"‚ôû",name:"Premium"},elite:{icon:"‚ôõ",name:"Elite"},admin:{icon:"üîê",name:"Admin"}},g=p[m]||p.free;d&&(d.textContent=g.icon),u&&(u.textContent=g.name),l&&(l.className="drawer-tier-badge "+m);const h="admin"===e?.role||"admin"===m;o&&(o.style.display=h?"block":"none")}else t&&(t.style.display="none"),n&&(n.style.display="none"),o&&(o.style.display="none"),s&&(s.style.display="flex"),r&&(r.style.display="none"),i&&(i.style.display="none")}function h(){document.documentElement.style.setProperty("--vh",.01*window.innerHeight+"px")}window.handleMobileLogout=function(){m();const e=document.getElementById("drawerLogoutBtn");e&&(e.textContent="‚è≥ Logging out...",e.disabled=!0),void 0!==AuthAPI&&AuthAPI.logout?AuthAPI.logout().then(()=>window.location.href="/").catch(()=>{localStorage.clear(),sessionStorage.clear(),window.location.href="/"}):(localStorage.clear(),sessionStorage.clear(),window.location.href="/")},window.addEventListener("resize","function"==typeof throttle?throttle(h,150):h),window.addEventListener("orientationchange",()=>setTimeout(h,100)),h();const f=document.createElement("style");f.textContent="@keyframes ripple { to { transform: scale(4); opacity: 0; } }",document.head.appendChild(f),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",l):l(),window.addEventListener("authStateChange",g),setTimeout(g,500),setTimeout(g,1500),window.MobileNav={openDrawer:u,closeDrawer:m,toggleDrawer:d,updateAuthState:g,updateActiveNavItem:p}}(),function(){"use strict";const e={showNotifications:!0,logToConsole:!0,maxErrors:10,ignoredMessages:["ResizeObserver loop","Script error.","Network request failed"]};let t=0;const n=[];function o(t){return!!t&&e.ignoredMessages.some(e=>t.toLowerCase().includes(e.toLowerCase()))}function s(t,o,s={}){if(!e.logToConsole)return;const r={type:t,message:o.message||o,stack:o.stack,timestamp:(new Date).toISOString(),url:window.location.href,...s};n.push(r),n.length>e.maxErrors&&n.shift(),Logger.error(`[SCP Error] ${t}:`,r)}function r(t){if(!e.showNotifications)return;if("function"==typeof showNotification)return void showNotification(t,"error");if("function"==typeof showPopupNotification)return void showPopupNotification(t,"‚ùå",5e3);const n=document.createElement("div");n.className="scp-error-toast",SafeHTML.setHTML(n,`\n      <span class="scp-error-icon">‚ö†Ô∏è</span>\n      <span class="scp-error-message">${SafeHTML.escapeText(t)}</span>\n    `),n.style.cssText="\n      position: fixed;\n      bottom: 80px;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(239, 68, 68, 0.95);\n      color: white;\n      padding: 12px 24px;\n      border-radius: 8px;\n      z-index: 10000;\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      font-family: 'Inter', sans-serif;\n      font-size: 14px;\n      box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n      animation: slideUp 0.3s ease;\n    ",document.body.appendChild(n),setTimeout(()=>{n.style.animation="slideDown 0.3s ease",setTimeout(()=>n.remove(),300)},5e3)}function i(e){const t=e.message||String(e);return t.includes("fetch")||t.includes("network")||t.includes("Failed to fetch")?"Connection error. Please check your internet.":t.includes("401")||t.includes("unauthorized")?"Session expired. Please log in again.":t.includes("403")||t.includes("forbidden")?"You don't have permission to do this.":t.includes("404")||t.includes("not found")?"The requested resource was not found.":t.includes("500")||t.includes("server")?"Server error. Please try again later.":"Something went wrong. Please try again."}window.onerror=function(e,n,a,c,l){return o(e)||(t++,s("uncaught",l||e,{source:n,lineno:a,colno:c}),t<=3&&r(i(l||{message:e}))),!1},window.onunhandledrejection=function(e){const n=e.reason,a=n?.message||String(n);o(a)||(t++,s("unhandledRejection",n),t<=3&&r(i(n||{message:a})))};const a=document.createElement("style");a.textContent="\n    @keyframes slideUp {\n      from { transform: translateX(-50%) translateY(100%); opacity: 0; }\n      to { transform: translateX(-50%) translateY(0); opacity: 1; }\n    }\n    @keyframes slideDown {\n      from { transform: translateX(-50%) translateY(0); opacity: 1; }\n      to { transform: translateX(-50%) translateY(100%); opacity: 0; }\n    }\n  ",document.head.appendChild(a),window.SCPErrorHandler={report:function(e,t={}){s("manual",e,t),r(i(e))},getLog:function(){return[...n]},clearLog:function(){n.length=0,t=0},configure:function(t){Object.assign(e,t)}}}(),function(){"use strict";const e={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4},t="localhost"!==window.location.hostname&&!window.location.hostname.includes("127.0.0.1"),n={level:t?e.WARN:e.DEBUG,prefix:"[SCP]",showTimestamp:!t,trackPerformance:!t},o=new Map;function s(e,t){const o=[n.prefix];return n.showTimestamp&&o.push((new Date).toISOString().substr(11,12)),o.push(`[${e}]`),o.join(" ")}const r={setLevel:function(t){n.level="string"==typeof t?e[t.toUpperCase()]||e.DEBUG:t},debug:function(...t){n.level<=e.DEBUG&&console.log(s("DEBUG"),...t)},info:function(...t){n.level<=e.INFO&&console.info(s("INFO"),...t)},warn:function(...t){n.level<=e.WARN&&console.warn(s("WARN"),...t)},error:function(...t){n.level<=e.ERROR&&console.error(s("ERROR"),...t)},time:function(e){n.trackPerformance&&o.set(e,performance.now())},timeEnd:function(e){if(n.trackPerformance&&o.has(e)){const t=performance.now()-o.get(e);return o.delete(e),this.debug(`${e}: ${t.toFixed(2)}ms`),t}return 0},group:function(t){n.level<=e.DEBUG&&console.group(s("GROUP"),t)},groupEnd:function(){n.level<=e.DEBUG&&console.groupEnd()},table:function(t){n.level<=e.DEBUG&&console.table(t)},configure:function(e){Object.assign(n,e)},isProduction:function(){return t}};window.Logger=r,r.debug("Logger initialized",{isProduction:t,level:n.level})}();const PerformanceUtils=function(){"use strict";return{throttle(e,t=100){let n=!1,o=null;return function(...s){n?o=s:(e.apply(this,s),n=!0,setTimeout(()=>{n=!1,o&&(e.apply(this,o),o=null)},t))}},debounce(e,t=250,n=!1){let o=null;return function(...s){const r=n&&!o;clearTimeout(o),o=setTimeout(()=>{o=null,n||e.apply(this,s)},t),r&&e.apply(this,s)}},rafThrottle(e){let t=!1;return function(...n){t||(requestAnimationFrame(()=>{e.apply(this,n),t=!1}),t=!0)}},lazyLoadImages(e="img[data-src]",t={}){const n=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target;t.dataset.src&&(t.src=t.dataset.src,t.removeAttribute("data-src")),t.dataset.srcset&&(t.srcset=t.dataset.srcset,t.removeAttribute("data-srcset")),n.unobserve(t)}})},{root:null,rootMargin:"50px",threshold:.1,...t});return document.querySelectorAll(e).forEach(e=>n.observe(e)),n},batchDOMUpdates:e=>new Promise(t=>{requestAnimationFrame(()=>{const n=document.createDocumentFragment();e(n),t(n)})})}}();"undefined"!=typeof module&&module.exports&&(module.exports=PerformanceUtils),function(){"use strict";const e=new Map;let t=0;window.registerListener=function(n,o,s,r){return n.addEventListener(o,s,r),e.set(++t,{el:n,evt:o,fn:s,opts:r}),t},window.removeListener=function(t){const n=e.get(t);n&&(n.el.removeEventListener(n.evt,n.fn,n.opts),e.delete(t))},window.cleanupAll=function(){e.forEach(e=>e.el.removeEventListener(e.evt,e.fn,e.opts)),e.clear()},window.addEventListener("beforeunload",cleanupAll)}(),function(){"use strict";const e={observer:null,init:function(e={}){const t={rootMargin:e.rootMargin||"50px 0px",threshold:e.threshold||.01,selector:e.selector||".lazy, [data-src]"};"IntersectionObserver"in window?(this.observer=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&(this.loadImage(e.target),this.observer.unobserve(e.target))})},{rootMargin:t.rootMargin,threshold:t.threshold}),document.querySelectorAll(t.selector).forEach(e=>{e.dataset.src&&this.observer.observe(e)}),Logger.debug("[LazyLoader] Initialized with IntersectionObserver")):(this.loadAll(t.selector),Logger.warn("[LazyLoader] IntersectionObserver not supported, loading all"))},loadImage:function(e){const t=e.dataset.src;if(!t)return;const n=new Image;n.onload=function(){e.src=t,e.classList.remove("lazy"),e.classList.add("lazy-loaded"),e.removeAttribute("data-src")},n.onerror=function(){Logger.warn("[LazyLoader] Failed to load:",t),e.classList.add("lazy-error")},n.src=t},loadAll:function(e){document.querySelectorAll(e).forEach(e=>{this.loadImage(e)})},refresh:function(){this.observer&&document.querySelectorAll(".lazy, [data-src]").forEach(e=>{e.dataset.src&&this.observer.observe(e)})},destroy:function(){this.observer&&(this.observer.disconnect(),this.observer=null)}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>e.init()):e.init(),window.LazyLoader=e}(),function(){"use strict";const e={errors:[],maxErrors:10,init:function(){window.onerror=(e,t,n,o,s)=>(this.handleError({type:"uncaught",message:e,source:t,lineno:n,colno:o,stack:s?.stack}),!1),window.addEventListener("unhandledrejection",e=>{this.handleError({type:"unhandledrejection",message:e.reason?.message||String(e.reason),stack:e.reason?.stack})}),Logger.debug("[ErrorBoundary] Initialized")},handleError:function(e){Logger.error("[ErrorBoundary] Caught error:",e),this.errors.push({...e,timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent}),this.errors.length>this.maxErrors&&this.errors.shift(),this.isCriticalError(e)&&this.showErrorUI(e)},isCriticalError:function(e){return[/ChunkLoadError/i,/Loading chunk/i,/Network Error/i,/Failed to fetch/i].some(t=>t.test(e.message)||t.test(e.stack||""))},showErrorUI:function(e){if(document.getElementById("error-boundary-toast"))return;const t=document.createElement("div");t.id="error-boundary-toast",t.style.cssText="\n                position: fixed;\n                bottom: 20px;\n                right: 20px;\n                background: #ff4444;\n                color: white;\n                padding: 16px 24px;\n                border-radius: 8px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n                z-index: 999999;\n                max-width: 400px;\n                font-family: system-ui, sans-serif;\n            ",t.innerHTML='\n                <div style="font-weight: bold; margin-bottom: 8px;">‚ö†Ô∏è Something went wrong</div>\n                <div style="font-size: 14px; opacity: 0.9;">Please refresh the page or try again later.</div>\n                <button onclick="location.reload()" style="\n                    margin-top: 12px;\n                    background: white;\n                    color: #ff4444;\n                    border: none;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    cursor: pointer;\n                    font-weight: bold;\n                ">Refresh Page</button>\n            ',document.body.appendChild(t),setTimeout(()=>{t.remove()},1e4)},getErrors:function(){return[...this.errors]},clearErrors:function(){this.errors=[]}};e.init(),window.ErrorBoundary=e}();